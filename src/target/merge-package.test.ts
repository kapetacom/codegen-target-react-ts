import { describe, it, expect } from '@jest/globals';

import { mergePackageJson } from './merge-package';
import { GeneratedFile, SourceFile } from '@kapeta/codegen-target';

describe('mergePackage', () => {
    it('should work with empty package', () => {
        const sourceFile: SourceFile = {
            filename: 'package.json',
            content: JSON.stringify({
                name: 'test',
            }),
            permissions: '644',
        };
        const newFile: GeneratedFile = {
            filename: 'package.json',
            content: JSON.stringify({
                name: 'test',
                dependencies: {
                    'test-dep': '1.0.0',
                },
            }),
            permissions: '644',
            mode: 'overwrite',
        };
        const lastFile: GeneratedFile | null = null;

        const result = mergePackageJson(sourceFile, newFile, lastFile);
        expect(JSON.parse(result.content.toString())).toMatchObject({
            name: 'test',
        });
    });

    it('should preserve existing deps', () => {
        const sourceFile: SourceFile = {
            filename: 'package.json',
            content: JSON.stringify({
                name: 'test',
                dependencies: {
                    'test-dep': '1.0.0',
                },
                devDependencies: {
                    '@babel/cli': '^7.23.0',
                    '@babel/core': '^7.23.2',
                    '@babel/plugin-proposal-class-properties': '^7.18.6',
                    '@babel/plugin-proposal-decorators': '^7.23.2',
                    '@babel/plugin-proposal-object-rest-spread': '^7.20.7',
                    '@babel/plugin-proposal-optional-chaining': '^7.21.0',
                    '@babel/plugin-proposal-private-property-in-object': '^7.21.11',
                    '@babel/preset-env': '^7.23.2',
                    '@babel/preset-react': '^7.22.15',
                    '@babel/preset-typescript': '^7.23.2',
                    '@emotion/react': '^11.11.1',
                    '@emotion/styled': '^11.11.0',
                    '@kapeta/nodejs-utils': '<2',
                    '@kapeta/prettier-config': '^0.6.0',
                    '@kapeta/schemas': '^0.1.1',
                    '@kapeta/style': '^0.84.0',
                    '@kapeta/ui-web-components': '<2',
                    '@kapeta/ui-web-context': '<2',
                    '@kapeta/ui-web-types': '<2',
                    '@kapeta/ui-web-utils': '<2',
                    '@kapeta/web-microfrontend': '>=0.12.11 <2',
                    '@mui/icons-material': '^5.14.3',
                    '@mui/material': '^5.14.3',
                    '@storybook/addon-actions': '^7.1.0',
                    '@storybook/addon-essentials': '^7.1.0',
                    '@storybook/addon-links': '^7.1.0',
                    '@storybook/addons': '^7.1.0',
                    '@storybook/react': '^7.1.0',
                    '@storybook/react-webpack5': '^7.5.1',
                    '@svgr/webpack': '6.4.0',
                    '@types/jest': '^29.1.2',
                    '@types/lodash': '^4.14.186',
                    '@types/luxon': '^3.1.0',
                    '@types/node': '^18.8.3',
                    '@types/react': '^18.0.21',
                    '@types/react-dom': '^18.0.6',
                    '@types/react-router-dom': '^5.3.3',
                    '@types/uuid': '^8.3.4',
                    'babel-jest': '^29.1.2',
                    'babel-loader': '8.2.5',
                    'babel-plugin-named-asset-import': '^0.3.8',
                    'babel-preset-react-app': '^10.0.1',
                    camelcase: '^7.0.0',
                    'case-sensitive-paths-webpack-plugin': '2.4.0',
                    chromatic: '^6.19.9',
                    'css-loader': '6.7.1',
                    dotenv: '16.0.3',
                    'dotenv-expand': '9.0.0',
                    'file-loader': '6.2.0',
                    'file-saver': '^2.0.5',
                    'fs-extra': '^10.1.0',
                    'guid-typescript': '^1.0.9',
                    'html-webpack-plugin': '5.5.0',
                    'identity-obj-proxy': '3.0.0',
                    jest: '29.1.2',
                    'jest-environment-jsdom-fourteen': '1.0.1',
                    'jest-resolve': '29.1.2',
                    'jest-watch-typeahead': '2.2.0',
                    'json-loader': '^0.5.7',
                    less: '^4.1.3',
                    'less-loader': '^11.1.0',
                    luxon: '^3.1.0',
                    'mini-css-extract-plugin': '2.6.1',
                    mobx: '^6.6.2',
                    'mobx-react': '^7.5.3',
                    msw: '^1.2.3',
                    'msw-storybook-addon': '^1.8.0',
                    'path-browserify': '^1.0.1',
                    'pnp-webpack-plugin': '1.7.0',
                    'postcss-flexbugs-fixes': '5.0.2',
                    'postcss-loader': '7.0.1',
                    'postcss-normalize': '10.0.1',
                    'postcss-preset-env': '7.8.2',
                    'postcss-safe-parser': '6.0.0',
                    prettier: '^2.8.8',
                    react: '^18.2.0',
                    'react-app-polyfill': '^3.0.0',
                    'react-dev-utils': '^12.0.1',
                    'react-dom': '^18.2.0',
                    'react-error-boundary': '^4.0.11',
                    'react-router-dom': '^6.17.0',
                    'react-use': '^17.4.0',
                    'react18-input-otp': '^1.1.4',
                    resolve: '1.22.1',
                    'resolve-url-loader': '5.0.0',
                    'sass-loader': '13.1.0',
                    semver: '7.3.8',
                    'socket.io-client': '^4.5.2',
                    storybook: '^7.5.1',
                    'style-loader': '3.3.3',
                    swr: '^2.2.0',
                    'terser-webpack-plugin': '5.3.9',
                    'ts-pnp': '1.2.0',
                    typescript: '^5.2.2',
                    unibabel: '^2.1.8',
                    'url-loader': '4.1.1',
                    uuid: '^9.0.0',
                    webpack: '5.89.0',
                    'webpack-cli': '^5.1.4',
                    'webpack-dev-server': '4.15.1',
                    'webpack-manifest-plugin': '5.0.0',
                    'workbox-webpack-plugin': '6.5.4',
                    'yaml-loader': '^0.5.0',
                },
            }),
            permissions: '644',
        };
        const newFile: GeneratedFile = {
            filename: 'package.json',
            content: JSON.stringify({
                name: 'test',
                dependencies: {
                    'test-dep2': '1.0.0',
                },
                devDependencies: {
                    '@types/react': '^18.0.27',
                    '@types/react-dom': '^18.0.10',
                    '@babel/cli': '^7.23.0',
                    '@babel/core': '^7.23.2',
                    '@babel/plugin-proposal-decorators': '^7.23.2',
                    '@babel/preset-env': '^7.23.2',
                    '@babel/preset-react': '^7.22.15',
                    '@babel/preset-typescript': '^7.23.2',
                    'react-refresh': '^0.14.0',
                    '@pmmmwh/react-refresh-webpack-plugin': '^0.5.11',
                    '@kapeta/eslint-config': '^0.7.0',
                    '@kapeta/prettier-config': '^0.6.2',
                    webpack: '^5.89.0',
                    'webpack-cli': '^5.1.4',
                    'webpack-dev-middleware': '^6.1.1',
                    'webpack-hot-middleware': '^2.25.4',
                    'babel-loader': '^9.1.3',
                    'clean-webpack-plugin': '^4.0.0',
                    'assets-webpack-plugin': '^7.1.1',
                    'style-loader': '^3.3.3',
                    'css-loader': '^6.8.1',
                    less: '^4.2.0',
                    'less-loader': '^11.1.3',
                    sass: '^1.69.4',
                    'sass-loader': '^13.3.2',
                    'mini-css-extract-plugin': '^2.7.6',
                    react: '^18.2.0',
                    'react-dom': '^18.2.0',
                    eslint: '^8.52.0',
                    'eslint-config-prettier': '^8.8.0',
                    prettier: '^2.8.8',
                    'cross-env': '^7.0.3',
                    nodemon: '^2.0.22',
                    '@kapeta/sdk-web-rest-client': '^2.1',
                    'copy-webpack-plugin': '^11.0.0',
                    msw: '^2.0.6',
                    '@kapeta/sdk-web-microfrontend-frame': '^1',
                },
            }),
            permissions: '644',
            mode: 'overwrite',
        };
        const lastFile: GeneratedFile | null = null;

        const result = mergePackageJson(sourceFile, newFile, lastFile);
        expect(JSON.parse(result.content.toString())).toMatchObject({
            name: 'test',
            dependencies: {
                'test-dep': '1.0.0',
                'test-dep2': '1.0.0',
            },
            devDependencies: {
                unibabel: 'aaa',
            },
        });
    });
});
